name: freevpsmarno

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 4320
    name: FREE VPS MARNO

    steps:
      - name: Setup hostname & root prompt
        run: |
          echo "freevpsmarno" | sudo tee /etc/hostname
          sudo hostnamectl set-hostname freevpsmarno
          sudo sed -i 's/127.0.1.1.*/127.0.1.1 freevpsmarno/' /etc/hosts
          sudo bash -c 'echo "export PS1=\"\u@freevpsmarno:\w# \"" > /root/.bashrc'

      - name: Detect VPS Specs & Region
        run: |
          VPS_CITY=$(curl -s https://ipinfo.io/city)
          VPS_REGION=$(curl -s https://ipinfo.io/region)
          VPS_COUNTRY=$(curl -s https://ipinfo.io/country)
          VPS_ORG=$(curl -s https://ipinfo.io/org)
          VPS_CPU_MODEL=$(lscpu | grep "Model name" | sed 's/Model name:[ \t]*//')
          VPS_CPU_CORES=$(lscpu | grep "^CPU(s):" | awk '{print $2}')
          VPS_RAM=$(free -h | grep Mem | awk '{print $2}')
          VPS_OS=$(lsb_release -ds)
          VPS_HOSTNAME=$(hostname)

          echo "VPS_CITY=$VPS_CITY" >> $GITHUB_ENV
          echo "VPS_REGION=$VPS_REGION" >> $GITHUB_ENV
          echo "VPS_COUNTRY=$VPS_COUNTRY" >> $GITHUB_ENV
          echo "VPS_ORG=$VPS_ORG" >> $GITHUB_ENV
          echo "VPS_CPU_MODEL=$VPS_CPU_MODEL" >> $GITHUB_ENV
          echo "VPS_CPU_CORES=$VPS_CPU_CORES" >> $GITHUB_ENV
          echo "VPS_RAM=$VPS_RAM" >> $GITHUB_ENV
          echo "VPS_OS=$VPS_OS" >> $GITHUB_ENV
          echo "VPS_HOSTNAME=$VPS_HOSTNAME" >> $GITHUB_ENV

      - name: Install tmate
        run: |
          sudo apt update
          sudo apt install -y tmate curl lsb-release

      - name: Start tmate session
        run: |
          export TERM=xterm
          sudo tmate -S /tmp/tmate.sock new-session -d -c /root >/dev/null 2>&1
          sudo tmate -S /tmp/tmate.sock wait tmate-ready
          SSH_CMD=$(sudo tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          WEB_CMD=$(sudo tmate -S /tmp/tmate.sock display -p '#{tmate_web}')
          echo "SSH_CMD=$SSH_CMD" >> $GITHUB_ENV
          echo "WEB_CMD=$WEB_CMD" >> $GITHUB_ENV

      - name: Send VPS info to Telegram
        run: |
          source $GITHUB_ENV
          BOT_TOKEN="8455335513:AAFD2QUku9-fxFpz9oIF33IFbYHDj08P7Yk"
          CHAT_ID="-1003046961134"

          MESSAGE=$(printf "✅ Sukses create Vps\nʙᴇʀɪᴋᴜᴛ ᴅᴇᴛᴀɪʟ Vᴘꜱ:\n\n🖥️ Hostname: %s\n⏰ Masa Aktif : 7 Jam\n📦 Spec: Ram %s Core %s\n💿 OS: %s\n🌍 Region: %s, %s, %s\n\n📡 ʟᴏɢɪɴ ᴠᴘꜱ:\n%s\n\n⚠️ 𝗧.𝗢.𝗦 𝗩𝗣𝗦:\n• ɴᴏ ʜᴀᴄᴋɪɴɢ\n• ɴᴏ ᴍɪɴɪɴɢ\n• ɴᴏ ᴛᴏʀʀᴇɴᴛ\n• ɴᴏ ᴏᴠᴇʀʟᴏᴀᴅ (100%% ᴄᴘᴜ)\n• ɴᴏ ᴅᴅᴏs\n• ɪɴᴛɪɴʏᴀ: ᴊᴀɴɢᴀɴ ᴅɪɢᴜɴᴀᴋᴀɴ ᴜɴᴛᴜᴋ ᴀᴋᴛɪꜰɪᴛᴀꜱ ɪʟᴇɢᴀʟ ᴀᴘᴀ ᴘᴜɴ\n\nDev By Marno" \
          "$VPS_HOSTNAME" "$VPS_RAM" "$VPS_CPU_CORES" "$VPS_OS" "$VPS_CITY" "$VPS_REGION" "$VPS_COUNTRY" "$SSH_CMD")

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
               -d chat_id="$CHAT_ID" \
               -d text="$MESSAGE"

      - name: Keep VPS alive silently
        run: |
          echo "🔥 VPS will stay alive until GitHub forces shutdown 🔥"
          while true; do sleep 300; done
